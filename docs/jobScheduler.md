---
layout: default
title: 四 作业调度系统使用
nav_order: 5
---

# 四 作业调度系统使用


## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

登录节点没有配置GPU卡，主要用于用户配置程序运行环境，编译程序等操作，如作业需要使用GPU资源，请参考如下说明：

## 4.1 节点信息查询

```
sinfo
查询当前可用的作业提交队列以及节点状态。当前可用作业队列如下：
```

| 名称 | 节点                | 用途                         |
| ---- | ------------------- | ---------------------------- |
| dlq  | compute01-compute05 | 可视化渲染，机器学习模型训练 |
| hpcq | compute06-compute07 | 科学计算                     |

常见节点状态以及说明如下：

| 状态  | 说明           |
| ----- | -------------- |
| idle  | 空闲           |
| alloc | 已被分配       |
| down  | 下线           |
| mix   | 已使用部分资源 |
| drain | 排空           |

注意：除idle和mix，其他状态节点均无法运行作业！

## 4.2 当前作业情况查询

```
squeue
```

当前运行和等待运行的作业列表，其中NODES NODELIST(REASON)为作业所在节点，或未执行的作业的等待原因。

## 4.3 交互式任务提交

```
srun <申请资源> <运行命令>
```

用户可以通过squeue查看分配的到的节点，程序运行结果会输出到屏幕。

## 4.4独占式任务提交（调试程序）

```
salloc <申请资源>
```

成功分配资源后，用户可以通过squeue查看分配的到的节点，并ssh到节点调试程序，解决程序了BUG后，再使用脚本式任务提交。

## 4.5 脚本式任务提交

### 4.5.1 作业提交流程

1.  构建任务提交脚本，具体参数见4.5.2及4.5.3
2.  执行命令，提交作业

```
sbatch <提交脚本>
```

### 4.5.2 GPU作业提交脚本

`#!/bin/bash`  

`#SBATCH -J JobName             #作业名为JobName
#SBATCH -p dlq                 #作业队列为dlq`

`#SBATCH -w compute01           #作业运行节点为compute01
#SBATCH -o Job.out             #标准输出重定向到Job.out
#SBATCH -N 1                   #作业申请1个节点
#SBATCH --ntasks-per-node=1    #单节点启动任务数为1
#SBATCH --cpus-per-task=1      #单任务使用的CPU核心数为1
#SBATCH -t 1:00:00             #任务运行时间最长为1小时
#SBATCH --gres=gpu:1           #单个节点使用一块GPU卡`

./my_script.sh \# 作业运行脚本

注意：

-   仅请求一个GPU时CPU个数不能超过6；
-   默认情况下内存占用与每节点CPU个数成正比；
-   不推荐指定节点提交，可能导致作业长时间排队。
-   直接运行Python程序请参考群文件中标准提交脚本的写法

### 4.4.3 MPI作业提交脚本

```
#!/bin/bash

#SBATCH -J JobName               #作业名为JobName
#SBATCH -o Job.out               #标准输出重定向到Job.out
#SBATCH -N 2                     #作业申请2个节点
#SBATCH --ntasks-per-node=4      #单节点启动任务数为4
#SBATCH -t 1:00:00               #任务运行时间最长为1小时

mpirun -np 8 ./my_script.sh #作业
```

说明：

-   该作业将申请2个节点，每个节点运行4个进程，一共开启8个进程。

## 4.5取消作业

```
scancel <作业ID> 
```

取消相应作业的等待或执行，作业ID可以通过squeue查询。

## 4.6 QOS质量服务

| 名称   | 用户     | 最大提交作业 | 最大运行作业 | 最大作业时长 |
| ------ | -------- | ------------ | ------------ | ------------ |
| normal | 基础用户 | 3            | 1            | 6-06:00:00   |
| expr   | 实验用户 | 1            | 1            | 00:05:00     |

注意：

-   超出作业最大时长，作业将被杀死；
-   超出最大提交作业，作业将提交失败；
-   超出最大运行作业，作业将被挂起，等待运行；
-   提交作业指定时间超出最大时长，作业将被挂起。